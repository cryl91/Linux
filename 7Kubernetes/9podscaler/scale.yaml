#The Horizontal Pod Autoscaler (HPA) in Kubernetes is a built-in controller that automatically adjusts the number of pod replicas in a deployment, replica set, or stateful set based on observed resource usage (like CPU or memory) or custom metrics.
#Install a metric server to calculate the cpu or memory usage(kubectl top pods) = kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  labels: #These labels are deployment set labels.Every k8s resources have labels
    app: guestbook
    tier: frontend
spec:
  # modify replicas according to your case
  replicas: 3
  selector: #selector should match with template. The selector should match with pod labels
    matchLabels:
      tier: nginx
      env: prod
  template: #Template is pod labels   
    metadata:
      labels:
        tier: nginx
        env: prod
    spec:
      containers: 
      - name: nginx
        image: nginx:latest
        ports: 
        - containerPort: 80
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: nginx
spec: #scaleTargetRef+minReplicas+maxReplicas+metrics
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: nginx
  minReplicas: 1
  maxReplicas: 5 
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 50 #Target CPU utilization = 50%
        #CPU utilization refers to how much CPU your pods are actually using compared to the CPU request value defined in the Pod/Deployment spec. For this you need to give the cpu resources and limits
        #Current CPU usage â†’ Collected from metrics-server (average across all pods targeted by the HPA). If more less scale pods or scale down pods
        #Every 15 seconds (by default), HPA fetches the current metrics from metrics-server. Example: Target CPU utilization: 50% and Current CPU utilization: 80%

# HPA adjusts the number of pods, not containers directly.
# In your Deployment, each pod runs one container (nginx).
# ðŸ“Š At Max Scaling:
# MaxReplicas: 5 â†’ This means up to 5 pods can be created.

# Since each pod has 1 container, you'll have:
# Max 5 pods Ã— 1 container per pod = 5 containers total
# The confusion might come from the replicas: 3 in the Deployment, but HPA overrides that based on CPU metrics.
# It does not multiply with initial replicas â€” it controls the total pod count within the range [minReplicas, maxReplicas].
# So the max number of nginx containers = 5, not 15.
# Summary: Initial pods = 3 (from replicas). HPA dynamically scales between 1 and 5 pods. Each pod = 1 container â†’ Max containers = 5
#HPA wonâ€™t instantly scale down if target utilization is less â€” it waits for a stabilization window (default ~5 min) to avoid thrashing.